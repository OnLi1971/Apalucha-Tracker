<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apalucha Family GPS Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    backgroundImage: {
                        'family-gradient': 'linear-gradient(135deg, #4c1d95 0%, #7c3aed 50%, #a855f7 100%)',
                    },
                    colors: {
                        'family-primary': '#7c3aed',
                        'family-secondary': '#a855f7',
                        'family-accent': '#06b6d4',
                        'family-dark': '#4c1d95',
                        'family-light': '#f3e8ff',
                        'member-dad': '#ef4444',
                        'member-mom': '#f59e0b',
                        'member-child1': '#10b981',
                        'member-child2': '#3b82f6',
                        'member-child3': '#8b5cf6',
                        'member-child4': '#f97316',
                    },
                    animation: {
                        'pulse-family': 'pulse-family 2s ease-in-out infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        'pulse-family': {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.6' },
                        },
                        'float': {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                    }
                }
            }
        }
    </script>
    <style>
        .family-gradient {
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 50%, #a855f7 100%);
        }
        .glass-effect {
            background: rgba(76, 29, 149, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .animate-pulse-family {
            animation: pulse-family 2s ease-in-out infinite;
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        .btn-primary {
            background: #a855f7;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: rgba(168, 85, 247, 0.9);
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background: rgba(168, 85, 247, 0.3);
            cursor: not-allowed;
            transform: none;
        }
        .btn-outline {
            border: 1px solid #06b6d4;
            color: #06b6d4;
            background: transparent;
            transition: all 0.3s ease;
        }
        .btn-outline:hover {
            background: #06b6d4;
            color: white;
            transform: translateY(-2px);
        }
        .btn-destructive {
            background: #ef4444;
            color: white;
        }
        .btn-destructive:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-secondary {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }
        .badge-destructive {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        .badge-outline {
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(76, 29, 149, 0.95);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            line-cap: round;
            line-join: round;
        }
        .icon-lg {
            width: 2rem;
            height: 2rem;
        }
        .icon-xl {
            width: 3rem;
            height: 3rem;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background: rgba(76, 29, 149, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            animation: scaleIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .member-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            position: relative;
            animation: pulse 2s infinite;
        }
        .member-marker::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 2px solid currentColor;
            opacity: 0.3;
            animation: ping 2s infinite;
        }
        @keyframes ping {
            0% { transform: scale(1); opacity: 0.3; }
            75%, 100% { transform: scale(2); opacity: 0; }
        }
        .family-map {
            min-height: 300px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        .map-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
        }
    </style>
</head>
<body class="min-h-screen family-gradient text-white">
    <div class="max-w-6xl mx-auto p-4 space-y-6">
        
        <!-- Header -->
        <div class="text-center space-y-2">
            <div class="flex items-center justify-center gap-3">
                <svg class="icon-lg text-family-secondary animate-float" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <h1 class="text-4xl font-bold">Apalucha Family Tracker</h1>
            </div>
            <div class="flex items-center justify-center gap-4">
                <span id="gpsStatus" class="badge badge-destructive animate-pulse-family">
                    GPS OFFLINE
                </span>
                <span id="familyStatus" class="badge badge-outline">
                    Bez skupiny
                </span>
                <span id="gpsAccuracy" class="text-sm text-white/70" style="display: none;">
                    Přesnost: -m
                </span>
            </div>
        </div>

        <!-- Family Group Section -->
        <div class="glass-effect rounded-lg">
            <div class="p-6">
                <h3 class="font-semibold text-family-secondary flex items-center gap-2 mb-4">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Rodinná skupina
                </h3>
                
                <div id="familyGroupContent">
                    <div id="noGroupView" class="text-center py-6">
                        <svg class="icon-xl mx-auto mb-4 text-white/50 animate-float" viewBox="0 0 24 24">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <p class="text-white/70 mb-4">Nejste připojeni k žádné rodinné skupině</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button id="createGroupBtn" class="btn-primary py-3 rounded-lg">
                                <span class="flex items-center justify-center gap-2">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="12" y1="8" x2="12" y2="16"></line>
                                        <line x1="8" y1="12" x2="16" y2="12"></line>
                                    </svg>
                                    Vytvořit skupinu
                                </span>
                            </button>
                            <button id="joinGroupBtn" class="btn-outline py-3 rounded-lg">
                                <span class="flex items-center justify-center gap-2">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="9" cy="7" r="4"></circle>
                                        <line x1="17" y1="11" x2="23" y2="11"></line>
                                    </svg>
                                    Připojit se
                                </span>
                            </button>
                        </div>
                    </div>

                    <div id="groupView" style="display: none;">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-lg font-semibold" id="groupName">Moje rodina</div>
                                    <div class="text-sm text-white/70">Kód skupiny: <span id="groupCode" class="font-mono">------</span></div>
                                </div>
                                <button id="leaveGroupBtn" class="text-red-400 hover:text-red-300 text-sm">
                                    Opustit skupinu
                                </button>
                            </div>
                            
                            <div id="familyMembers" class="space-y-2">
                                <!-- Family members will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Family Map -->
        <div id="familyMapSection" class="glass-effect rounded-lg" style="display: none;">
            <div class="p-6">
                <h3 class="font-semibold text-family-accent flex items-center gap-2 mb-4">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    Mapa rodiny
                </h3>
                
                <div id="familyMap" class="family-map">
                    <div class="map-grid"></div>
                    <div id="mapMembers" class="absolute inset-0 p-4">
                        <!-- Family member positions will be shown here -->
                    </div>
                </div>
                
                <div class="mt-4 text-xs text-white/50 text-center">
                    Pozice se automaticky aktualizují každých 10 sekund
                </div>
            </div>
        </div>

        <!-- Current Position Card -->
        <div class="glass-effect rounded-lg">
            <div class="p-6">
                <h3 class="font-semibold text-family-secondary flex items-center gap-2 mb-4">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    Vaše poloha
                </h3>
                
                <div id="positionDisplay">
                    <div class="text-center py-8">
                        <svg class="icon-xl mx-auto mb-4 text-white/50 animate-float" viewBox="0 0 24 24">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <p class="text-white/70">Čekání na GPS signál...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass-effect rounded-lg">
                <div class="p-4 text-center">
                    <div id="totalDistance" class="text-2xl font-bold text-family-secondary">0.00</div>
                    <div class="text-xs text-white/70">Celková vzdálenost (km)</div>
                </div>
            </div>
            
            <div class="glass-effect rounded-lg">
                <div class="p-4 text-center">
                    <div id="totalTime" class="text-2xl font-bold text-family-accent">00:00:00</div>
                    <div class="text-xs text-white/70 flex items-center justify-center gap-1">
                        <svg class="icon" style="width: 0.75rem; height: 0.75rem;" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                        Celkový čas
                    </div>
                </div>
            </div>
            
            <div class="glass-effect rounded-lg">
                <div class="p-4 text-center">
                    <div id="maxSpeed" class="text-2xl font-bold text-white">0.0</div>
                    <div class="text-xs text-white/70">Max rychlost (km/h)</div>
                </div>
            </div>
            
            <div class="glass-effect rounded-lg">
                <div class="p-4 text-center">
                    <div id="avgSpeed" class="text-2xl font-bold text-white">0.0</div>
                    <div class="text-xs text-white/70">Průměr (km/h)</div>
                </div>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="space-y-3">
            <button id="startBtn" class="w-full btn-primary py-4 text-lg rounded-lg disabled:opacity-50" disabled>
                <span class="flex items-center justify-center gap-2">
                    <svg class="icon" viewBox="0 0 24 24">
                        <polygon points="5,3 19,12 5,21"></polygon>
                    </svg>
                    Začít sledování GPS
                </span>
            </button>
            
            <div id="activeControls" class="grid grid-cols-2 gap-3" style="display: none;">
                <button id="pauseBtn" class="btn-outline py-4 rounded-lg">
                    <span class="flex items-center justify-center gap-2">
                        <svg class="icon" viewBox="0 0 24 24">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                        Pozastavit
                    </span>
                </button>
                
                <button id="stopBtn" class="btn-destructive py-4 rounded-lg">
                    <span class="flex items-center justify-center gap-2">
                        <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                    </span>
                    Ukončit
                </button>
            </div>
            
            <button id="resetBtn" class="w-full border border-white/30 text-white/70 hover:bg-white/10 py-3 rounded-lg transition-all disabled:opacity-50" disabled>
                <span class="flex items-center justify-center gap-2">
                    <svg class="icon" viewBox="0 0 24 24">
                        <polyline points="1,4 1,10 7,10"></polyline>
                        <path d="M3.51,15a9,9,0,0,0,15.92-8.63L7,10"></path>
                    </svg>
                    Vymazat všechna data
                </span>
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Modals -->
    <div id="createGroupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-center">Vytvořit rodinnou skupinu</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Název skupiny</label>
                    <input id="groupNameInput" type="text" placeholder="např. Naše rodina" 
                           class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:border-family-secondary focus:outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Vaše jméno</label>
                    <input id="memberNameInput" type="text" placeholder="např. Táta" 
                           class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:border-family-secondary focus:outline-none">
                </div>
                <div class="flex gap-3">
                    <button id="confirmCreateGroup" class="flex-1 btn-primary py-3 rounded-lg">Vytvořit</button>
                    <button id="cancelCreateGroup" class="flex-1 btn-outline py-3 rounded-lg">Zrušit</button>
                </div>
            </div>
        </div>
    </div>

    <div id="joinGroupModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-center">Připojit se ke skupině</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Kód skupiny</label>
                    <input id="joinGroupCodeInput" type="text" placeholder="Zadejte 6-místný kód" 
                           class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:border-family-secondary focus:outline-none uppercase text-center text-2xl font-mono">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Vaše jméno</label>
                    <input id="joinMemberNameInput" type="text" placeholder="např. Tomáš" 
                           class="w-full p-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-white/50 focus:border-family-secondary focus:outline-none">
                </div>
                <div class="flex gap-3">
                    <button id="confirmJoinGroup" class="flex-1 btn-primary py-3 rounded-lg">Připojit se</button>
                    <button id="cancelJoinGroup" class="flex-1 btn-outline py-3 rounded-lg">Zrušit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log("Apalucha Family GPS Tracker initializing");
        
        // Family tracking variables
        let familyGroup = null;
        let currentMember = null;
        let familyMembers = {};
        let familyUpdateInterval = null;
        
        // GPS tracking variables
        let isTracking = false;
        let isPaused = false;
        let currentPosition = null;
        let route = [];
        let stats = {
            distance: 0,
            duration: 0,
            maxSpeed: 0,
            avgSpeed: 0,
            currentSpeed: 0
        };
        let gpsAccuracy = null;
        let isGpsEnabled = false;
        let lastUpdateTime = '';
        
        let watchId = null;
        let startTime = null;
        let lastPosition = null;

        // Member colors
        const memberColors = [
            '#ef4444', // red
            '#f59e0b', // amber  
            '#10b981', // emerald
            '#3b82f6', // blue
            '#8b5cf6', // violet
            '#f97316', // orange
            '#06b6d4', // cyan
            '#84cc16'  // lime
        ];

        // Toast function
        function showToast(title, description, variant = 'default') {
            console.log(`Toast: ${title} - ${description}`);
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="font-semibold">${title}</div>
                <div class="text-sm opacity-90">${description}</div>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Generate group code
        function generateGroupCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Create family group
        function createFamilyGroup(groupName, memberName) {
            console.log("Creating family group:", groupName, memberName);
            
            const groupCode = generateGroupCode();
            const memberId = Date.now().toString();
            
            familyGroup = {
                id: groupCode,
                name: groupName,
                created: Date.now(),
                members: {}
            };
            
            currentMember = {
                id: memberId,
                name: memberName,
                color: memberColors[0],
                isOwner: true,
                lastUpdate: Date.now()
            };
            
            familyGroup.members[memberId] = currentMember;
            familyMembers[memberId] = currentMember;
            
            // Save to localStorage
            localStorage.setItem('familyGroup', JSON.stringify(familyGroup));
            localStorage.setItem('currentMember', JSON.stringify(currentMember));
            localStorage.setItem(`familyGroup_${groupCode}`, JSON.stringify(familyGroup));
            
            updateFamilyUI();
            startFamilyUpdates();
            showToast("Skupina vytvořena", `Kód skupiny: ${groupCode}`);
        }

        // Join family group
        function joinFamilyGroup(groupCode, memberName) {
            console.log("Joining family group:", groupCode, memberName);
            
            // Try to load existing group
            const existingGroup = localStorage.getItem(`familyGroup_${groupCode}`);
            if (!existingGroup) {
                showToast("Chyba", "Skupina s tímto kódem neexistuje", "destructive");
                return false;
            }
            
            familyGroup = JSON.parse(existingGroup);
            const memberId = Date.now().toString();
            const memberCount = Object.keys(familyGroup.members).length;
            
            currentMember = {
                id: memberId,
                name: memberName,
                color: memberColors[memberCount % memberColors.length],
                isOwner: false,
                lastUpdate: Date.now()
            };
            
            familyGroup.members[memberId] = currentMember;
            familyMembers = {...familyGroup.members};
            
            // Save to localStorage
            localStorage.setItem('familyGroup', JSON.stringify(familyGroup));
            localStorage.setItem('currentMember', JSON.stringify(currentMember));
            localStorage.setItem(`familyGroup_${groupCode}`, JSON.stringify(familyGroup));
            
            updateFamilyUI();
            startFamilyUpdates();
            showToast("Připojeno", `Připojili jste se ke skupině ${familyGroup.name}`);
            return true;
        }

        // Leave family group
        function leaveFamilyGroup() {
            console.log("Leaving family group");
            
            if (familyGroup && currentMember) {
                // Remove from group
                delete familyGroup.members[currentMember.id];
                localStorage.setItem(`familyGroup_${familyGroup.id}`, JSON.stringify(familyGroup));
            }
            
            // Clear local data
            familyGroup = null;
            currentMember = null;
            familyMembers = {};
            
            localStorage.removeItem('familyGroup');
            localStorage.removeItem('currentMember');
            
            if (familyUpdateInterval) {
                clearInterval(familyUpdateInterval);
                familyUpdateInterval = null;
            }
            
            updateFamilyUI();
            showToast("Skupina opuštěna", "Byli jste odpojeni od rodinné skupiny");
        }

        // Update member position
        function updateMemberPosition() {
            if (!familyGroup || !currentMember || !currentPosition) return;
            
            console.log("Updating member position for family sharing");
            
            currentMember.position = {
                lat: currentPosition.lat,
                lng: currentPosition.lng,
                timestamp: Date.now(),
                accuracy: gpsAccuracy || 0,
                speed: stats.currentSpeed
            };
            currentMember.lastUpdate = Date.now();
            
            // Update in group
            familyGroup.members[currentMember.id] = currentMember;
            familyMembers[currentMember.id] = currentMember;
            
            // Save to localStorage
            localStorage.setItem('familyGroup', JSON.stringify(familyGroup));
            localStorage.setItem('currentMember', JSON.stringify(currentMember));
            localStorage.setItem(`familyGroup_${familyGroup.id}`, JSON.stringify(familyGroup));
        }

        // Load family data from other members
        function loadFamilyUpdates() {
            if (!familyGroup) return;
            
            console.log("Loading family updates from localStorage");
            
            const updatedGroup = localStorage.getItem(`familyGroup_${familyGroup.id}`);
            if (updatedGroup) {
                const parsedGroup = JSON.parse(updatedGroup);
                familyMembers = {...parsedGroup.members};
                updateFamilyMembersDisplay();
                updateFamilyMap();
            }
        }

        // Start family updates
        function startFamilyUpdates() {
            if (familyUpdateInterval) {
                clearInterval(familyUpdateInterval);
            }
            
            console.log("Starting family position updates");
            familyUpdateInterval = setInterval(() => {
                updateMemberPosition();
                loadFamilyUpdates();
            }, 10000); // Every 10 seconds
        }

        // Update family UI
        function updateFamilyUI() {
            const noGroupView = document.getElementById('noGroupView');
            const groupView = document.getElementById('groupView');
            const familyMapSection = document.getElementById('familyMapSection');
            const familyStatus = document.getElementById('familyStatus');
            
            if (familyGroup && currentMember) {
                noGroupView.style.display = 'none';
                groupView.style.display = 'block';
                familyMapSection.style.display = 'block';
                
                document.getElementById('groupName').textContent = familyGroup.name;
                document.getElementById('groupCode').textContent = familyGroup.id;
                
                familyStatus.textContent = `${familyGroup.name} (${Object.keys(familyGroup.members).length} členů)`;
                familyStatus.className = 'badge badge-secondary';
                
                updateFamilyMembersDisplay();
                updateFamilyMap();
            } else {
                noGroupView.style.display = 'block';
                groupView.style.display = 'none';
                familyMapSection.style.display = 'none';
                
                familyStatus.textContent = 'Bez skupiny';
                familyStatus.className = 'badge badge-outline';
            }
        }

        // Update family members display
        function updateFamilyMembersDisplay() {
            const container = document.getElementById('familyMembers');
            container.innerHTML = '';
            
            Object.values(familyMembers).forEach(member => {
                const isOnline = member.lastUpdate && (Date.now() - member.lastUpdate) < 60000; // 1 minute
                const lastSeen = member.lastUpdate ? new Date(member.lastUpdate).toLocaleTimeString() : 'Nikdy';
                
                const memberElement = document.createElement('div');
                memberElement.className = 'flex items-center justify-between p-3 bg-white/5 rounded-lg';
                memberElement.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="member-marker" style="background-color: ${member.color}"></div>
                        <div>
                            <div class="font-medium">${member.name} ${member.id === currentMember?.id ? '(vy)' : ''}</div>
                            <div class="text-xs text-white/70">
                                ${isOnline ? '🟢 Online' : '🔴 Offline'} • ${lastSeen}
                            </div>
                        </div>
                    </div>
                    ${member.position ? `
                        <div class="text-right text-xs text-white/70">
                            <div>${member.position.speed.toFixed(1)} km/h</div>
                            <div>${Math.round(member.position.accuracy)}m přesnost</div>
                        </div>
                    ` : ''}
                `;
                container.appendChild(memberElement);
            });
        }

        // Update family map
        function updateFamilyMap() {
            const container = document.getElementById('mapMembers');
            container.innerHTML = '';
            
            // Calculate bounds
            let positions = Object.values(familyMembers)
                .filter(member => member.position)
                .map(member => member.position);
            
            if (positions.length === 0) {
                container.innerHTML = '<div class="text-center text-white/50 p-8">Žádné pozice k zobrazení</div>';
                return;
            }
            
            const lats = positions.map(p => p.lat);
            const lngs = positions.map(p => p.lng);
            const minLat = Math.min(...lats);
            const maxLat = Math.max(...lats);
            const minLng = Math.min(...lngs);
            const maxLng = Math.max(...lngs);
            
            const mapWidth = container.offsetWidth - 32; // padding
            const mapHeight = container.offsetHeight - 32;
            
            // Position members on map
            Object.values(familyMembers).forEach(member => {
                if (!member.position) return;
                
                const x = ((member.position.lng - minLng) / (maxLng - minLng)) * mapWidth + 16;
                const y = mapHeight - ((member.position.lat - minLat) / (maxLat - minLat)) * mapHeight + 16;
                
                const memberDot = document.createElement('div');
                memberDot.style.position = 'absolute';
                memberDot.style.left = `${x}px`;
                memberDot.style.top = `${y}px`;
                memberDot.style.transform = 'translate(-50%, -50%)';
                memberDot.innerHTML = `
                    <div class="member-marker" style="background-color: ${member.color}; width: 16px; height: 16px;"></div>
                    <div class="text-xs text-white bg-black/50 px-2 py-1 rounded mt-1 whitespace-nowrap">
                        ${member.name}
                    </div>
                `;
                container.appendChild(memberDot);
            });
        }

        // Distance calculation
        function calculateDistance(pos1, pos2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
            const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Update stats
        function updateStats(newPosition) {
            console.log("Updating stats with new position:", newPosition);
            
            const now = Date.now();
            const currentSpeed = newPosition.speed ? newPosition.speed * 3.6 : 0; // Convert m/s to km/h
            
            let newDistance = stats.distance;
            
            if (lastPosition) {
                const segmentDistance = calculateDistance(lastPosition, newPosition);
                newDistance += segmentDistance;
            }
            
            const duration = startTime ? (now - startTime) / 1000 : 0;
            const maxSpeed = Math.max(stats.maxSpeed, currentSpeed);
            const avgSpeed = duration > 0 ? (newDistance / 1000) / (duration / 3600) : 0;
            
            stats = {
                distance: newDistance,
                duration,
                maxSpeed,
                avgSpeed,
                currentSpeed
            };
            
            updateUI();
        }

        // Format time
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Format coordinates
        function formatCoordinates(lat, lng) {
            return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        // Update UI
        function updateUI() {
            // Update position display
            if (currentPosition) {
                document.getElementById('positionDisplay').innerHTML = `
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-white/70">Souřadnice</div>
                                <div class="font-mono text-lg">
                                    ${formatCoordinates(currentPosition.lat, currentPosition.lng)}
                                </div>
                            </div>
                            <div>
                                <div class="text-sm text-white/70">Poslední aktualizace</div>
                                <div class="font-mono text-lg">${lastUpdateTime}</div>
                            </div>
                        </div>
                        
                        <div class="mt-4 p-4 bg-white/5 rounded-lg">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-family-secondary">
                                    ${stats.currentSpeed.toFixed(1)}
                                </div>
                                <div class="text-sm text-white/70">km/h aktuální rychlost</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update stats
            document.getElementById('totalDistance').textContent = (stats.distance / 1000).toFixed(2);
            document.getElementById('totalTime').textContent = formatTime(stats.duration);
            document.getElementById('maxSpeed').textContent = stats.maxSpeed.toFixed(1);
            document.getElementById('avgSpeed').textContent = stats.avgSpeed.toFixed(1);
            
            // Update controls
            document.getElementById('startBtn').style.display = isTracking ? 'none' : 'block';
            document.getElementById('activeControls').style.display = isTracking ? 'grid' : 'none';
            document.getElementById('resetBtn').disabled = isTracking;
            
            const pauseBtn = document.getElementById('pauseBtn');
            if (isPaused) {
                pauseBtn.innerHTML = `
                    <span class="flex items-center justify-center gap-2">
                        <svg class="icon" viewBox="0 0 24 24">
                            <polygon points="5,3 19,12 5,21"></polygon>
                        </svg>
                        Pokračovat
                    </span>
                `;
            } else {
                pauseBtn.innerHTML = `
                    <span class="flex items-center justify-center gap-2">
                        <svg class="icon" viewBox="0 0 24 24">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                        Pozastavit
                    </span>
                `;
            }
        }

        // Start tracking
        function startTracking() {
            console.log("Starting GPS tracking");
            
            if (!navigator.geolocation) return;
            
            isTracking = true;
            isPaused = false;
            startTime = Date.now();
            
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    console.log("GPS position update:", position.coords);
                    
                    const newPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        timestamp: Date.now(),
                        speed: position.coords.speed || 0
                    };
                    
                    currentPosition = newPos;
                    gpsAccuracy = position.coords.accuracy;
                    lastUpdateTime = new Date().toLocaleTimeString();
                    
                    if (!isPaused) {
                        route.push(newPos);
                        updateStats(newPos);
                        lastPosition = newPos;
                    }
                    
                    // Update family position
                    updateMemberPosition();
                    
                    updateUI();
                },
                (error) => {
                    console.error("GPS tracking error:", error);
                    showToast("GPS chyba během sledování", error.message, "destructive");
                },
                { 
                    enableHighAccuracy: true, 
                    timeout: 5000, 
                    maximumAge: 1000 
                }
            );
            
            updateUI();
            showToast("Sledování zahájeno", "GPS tracking je aktivní");
        }

        // Pause tracking
        function pauseTracking() {
            console.log("Pausing GPS tracking");
            isPaused = !isPaused;
            
            updateUI();
            showToast(
                isPaused ? "Sledování pozastaveno" : "Sledování obnoveno",
                isPaused ? "GPS tracking je pozastaven" : "GPS tracking pokračuje"
            );
        }

        // Stop tracking
        function stopTracking() {
            console.log("Stopping GPS tracking");
            
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            isTracking = false;
            isPaused = false;
            startTime = null;
            lastPosition = null;
            
            updateUI();
            showToast("Sledování ukončeno", `Celková vzdálenost: ${(stats.distance / 1000).toFixed(2)} km`);
        }

        // Reset tracking
        function resetTracking() {
            console.log("Resetting GPS tracking data");
            
            stopTracking();
            route = [];
            stats = {
                distance: 0,
                duration: 0,
                maxSpeed: 0,
                avgSpeed: 0,
                currentSpeed: 0
            };
            
            updateUI();
            showToast("Data vymazána", "Všechny záznamy byly smazány");
        }

        // Initialize GPS
        function initGPS() {
            console.log("Checking GPS availability");
            
            if (!navigator.geolocation) {
                showToast("GPS není podporováno", "Váš prohlížeč nepodporuje geolokaci", "destructive");
                return;
            }

            // Get initial position
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log("Initial GPS position obtained:", position.coords);
                    const newPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        timestamp: Date.now(),
                        speed: position.coords.speed || 0
                    };
                    currentPosition = newPos;
                    gpsAccuracy = position.coords.accuracy;
                    isGpsEnabled = true;
                    lastUpdateTime = new Date().toLocaleTimeString();
                    
                    // Update GPS status
                    document.getElementById('gpsStatus').textContent = 'GPS AKTIVNÍ';
                    document.getElementById('gpsStatus').className = 'badge badge-secondary animate-pulse-family';
                    document.getElementById('gpsAccuracy').style.display = 'inline';
                    document.getElementById('gpsAccuracy').textContent = `Přesnost: ${Math.round(position.coords.accuracy)}m`;
                    
                    // Enable start button
                    document.getElementById('startBtn').disabled = false;
                    
                    // Update family position if in group
                    updateMemberPosition();
                    
                    updateUI();
                    showToast("GPS připojen", `Přesnost: ${Math.round(position.coords.accuracy)}m`);
                },
                (error) => {
                    console.error("GPS error:", error);
                    showToast("GPS chyba", error.message, "destructive");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        }

        // Load saved family data on startup
        function loadSavedFamilyData() {
            console.log("Loading saved family data");
            
            const savedGroup = localStorage.getItem('familyGroup');
            const savedMember = localStorage.getItem('currentMember');
            
            if (savedGroup && savedMember) {
                familyGroup = JSON.parse(savedGroup);
                currentMember = JSON.parse(savedMember);
                
                // Load all members
                const fullGroup = localStorage.getItem(`familyGroup_${familyGroup.id}`);
                if (fullGroup) {
                    const parsedGroup = JSON.parse(fullGroup);
                    familyMembers = {...parsedGroup.members};
                }
                
                updateFamilyUI();
                startFamilyUpdates();
                console.log("Family data loaded:", familyGroup.name);
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startTracking);
        document.getElementById('pauseBtn').addEventListener('click', pauseTracking);
        document.getElementById('stopBtn').addEventListener('click', stopTracking);
        document.getElementById('resetBtn').addEventListener('click', resetTracking);

        // Family group event listeners
        document.getElementById('createGroupBtn').addEventListener('click', () => showModal('createGroupModal'));
        document.getElementById('joinGroupBtn').addEventListener('click', () => showModal('joinGroupModal'));
        document.getElementById('leaveGroupBtn').addEventListener('click', leaveFamilyGroup);

        // Create group modal
        document.getElementById('confirmCreateGroup').addEventListener('click', () => {
            const groupName = document.getElementById('groupNameInput').value.trim();
            const memberName = document.getElementById('memberNameInput').value.trim();
            
            if (!groupName || !memberName) {
                showToast("Chyba", "Vyplňte všechna pole", "destructive");
                return;
            }
            
            createFamilyGroup(groupName, memberName);
            hideModal('createGroupModal');
            
            // Clear inputs
            document.getElementById('groupNameInput').value = '';
            document.getElementById('memberNameInput').value = '';
        });

        document.getElementById('cancelCreateGroup').addEventListener('click', () => {
            hideModal('createGroupModal');
            document.getElementById('groupNameInput').value = '';
            document.getElementById('memberNameInput').value = '';
        });

        // Join group modal
        document.getElementById('confirmJoinGroup').addEventListener('click', () => {
            const groupCode = document.getElementById('joinGroupCodeInput').value.trim().toUpperCase();
            const memberName = document.getElementById('joinMemberNameInput').value.trim();
            
            if (!groupCode || !memberName) {
                showToast("Chyba", "Vyplňte všechna pole", "destructive");
                return;
            }
            
            if (groupCode.length !== 6) {
                showToast("Chyba", "Kód skupiny musí mít 6 znaků", "destructive");
                return;
            }
            
            if (joinFamilyGroup(groupCode, memberName)) {
                hideModal('joinGroupModal');
                
                // Clear inputs
                document.getElementById('joinGroupCodeInput').value = '';
                document.getElementById('joinMemberNameInput').value = '';
            }
        });

        document.getElementById('cancelJoinGroup').addEventListener('click', () => {
            hideModal('joinGroupModal');
            document.getElementById('joinGroupCodeInput').value = '';
            document.getElementById('joinMemberNameInput').value = '';
        });

        // Format group code input
        document.getElementById('joinGroupCodeInput').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 6);
        });

        // Initialize
        loadSavedFamilyData();
        initGPS();
        updateUI();
    </script>
</body>
</html>
